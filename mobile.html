
<!DOCTYPE html>
<html lang="en" dir="ltr" >
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script type="text/javascript" src="js/BufferLoader.js"></script>
</head>
<body>
  <button id="hoverBtn">Hover hand</button>
  <button id="unhoverBtn">Unhover hand</button>
  <video id="video" width="640" height="480" autoplay></video>
  <br />
  <br />
  <br />
  <button id="takeBase">TAKE BASE LAYER</button>
  <div id="content">

  </div>
  <script>
    var songsToLoad = ['sounds/tone1.wav'];

    var toneNumber = 2;
    var socket = io();

    // When song request recieved
    socket.on('SONG', function(toneNumber){
      if(toneNumber == -1){
        // Stop playing the tone
      } else {
        // Start playing the tone
        $('#content').append('\n Got Message: ' + toneNumber);
      }
    });

    socket.on('BASE', function(toneNumber){

      $('#content').append('\n Take Base layer');

    });

    function takeBaseLayer(){
      socket.emit('BASE', '1');
    }

    // Test Hover
    $( document ).ready(function() {
      console.log('ready');
      $('#takeBase').click(function() {
        socket.emit('BASE', '1');
        return false;
      });

    });

    // Put event listeners into place
    window.addEventListener("DOMContentLoaded", function() {
      // Grab elements, create settings, etc.

        hoverButton = document.getElementById("hoverBtn");
        unhoverButton = document.getElementById("unhoverBtn");

        hoverButton.addEventListener("click", onHover);
        unhoverButton.addEventListener("click", onHoverStop);

        video = document.getElementById("video"),
        videoObj = { "video": true },
        errBack = function(error) {
          console.log("Video capture error: ", error.code); 
        };

      // Put video listeners into place
      if(navigator.getUserMedia) { // Standard
        navigator.getUserMedia(videoObj, function(stream) {
          video.src = stream;
          video.play();
        }, errBack);
      } else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
        navigator.webkitGetUserMedia(videoObj, function(stream){
          video.src = window.webkitURL.createObjectURL(stream);
          video.play();
        }, errBack);
      } else if(navigator.mozGetUserMedia) { // WebKit-prefixed
        navigator.mozGetUserMedia(videoObj, function(stream){
          video.src = window.URL.createObjectURL(stream);
          video.play();
        }, errBack);
      }

    }, false);

    window.onload = init;
    var context;
    var bufferLoader;

    function init() {
      // Fix up prefixing
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();

      bufferLoader = new BufferLoader(
            context,
              songsToLoad,
        finishedLoading
        );

      bufferLoader.load();
    }

    var globalBufferList = [];
    var globalSourceList = [];
    function finishedLoading(bufferList) {


      for (var i=0; i<bufferList.length; i++) {
        globalBufferList[i] = bufferList[i];
      }

    }

    function setSound(index, state) {
      if(state == 1) {
        var source = context.createBufferSource();

        source.buffer = globalBufferList[index];


        source.connect(context.destination);

        source.loop = true;
        globalSourceList[index] = source;

        globalSourceList[index].start();
      } else {
        globalSourceList[index].stop();
        globalSourceList[index] = undefined;
      }
    }

    function onHover() {
      console.log('hovering');
      socket.emit('INFO', toneNumber);
    }

    function onHoverStop() {
      console.log('stopped hovering :(');
      socket.emit('INFO', -1);
    }

    // lowLag.init({'force': 'webkitAudio'});
    // lowLag.load("tune.mp3");
    // lowLag.play("tune.mp3");



  </script>
</body>
</html>